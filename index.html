<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ativação Curso Precificação</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script type="module">
// Importações Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAhD-K0KUEH-jc6t3HKGa5zQVwt8dTM6H4",
  authDomain: "cursoprecificacao-464f0.firebaseapp.com",
  projectId: "cursoprecificacao-464f0",
  storageBucket: "cursoprecificacao-464f0.appspot.com",
  messagingSenderId: "835557952690",
  appId: "1:835557952690:web:d2e6f84856d5eec1084dab"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

window.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("container");
  let chaveValidada = null;

  container.innerHTML = `
    <h3 class="mb-3">Digite sua chave de ativação</h3>
    <input id="inputChave" type="text" class="form-control mb-2" placeholder="Ex: ABC123-KAUAN" />
    <button id="btnValidarChave" class="btn btn-primary">Validar Chave</button>
    <div id="msg" class="mt-3 text-danger"></div>
  `;

  document.getElementById("btnValidarChave").onclick = async () => {
    const chave = document.getElementById("inputChave").value.trim().toUpperCase();
    const msg = document.getElementById("msg");
    msg.textContent = "";

    if (!chave) {
      msg.textContent = "Por favor, digite a chave.";
      return;
    }

    // Verificar no Firestore
    const docRef = doc(db, "chaves", chave);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      msg.textContent = "Chave inválida.";
      return;
    }

    const data = docSnap.data();
    if (data.usada) {
      msg.textContent = "Chave já foi usada.";
      return;
    }

    chaveValidada = chave;

    // Trocar para login Google
    container.innerHTML = `
      <h3 class="mb-3">Chave validada! Agora faça login com Google</h3>
      <button id="btnLoginGoogle" class="btn btn-success">Entrar com Google</button>
      <div id="msgLogin" class="mt-3 text-danger"></div>
    `;

    document.getElementById("btnLoginGoogle").onclick = async () => {
      try {
        const resultado = await signInWithPopup(auth, provider);
        const user = resultado.user;

        // Atualizar o documento da chave com email e usada = true
        await updateDoc(docRef, {
          usada: true,
          email: user.email
        });

        container.innerHTML = `
          <h3 class="text-success">✅ Curso ativado para: ${user.email}</h3>
          <p>Obrigado por adquirir o curso!</p>
        `;
      } catch (error) {
        document.getElementById("msgLogin").textContent = "Erro no login: " + error.message;
      }
    };
  };
});
</script>
</head>
<body class="d-flex flex-column align-items-center justify-content-center vh-100 bg-light">
  <div id="container" class="p-4 rounded shadow bg-white" style="max-width: 400px; width: 100%;"></div>
</body>
</html>
